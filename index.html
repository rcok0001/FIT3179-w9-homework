<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Australian Energy — Choropleth Overview</title>

  <style>
    :root { --container: 1200px; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #1f2937;
      background: #f9fafb;
    }
    header {
      padding: 48px 16px 16px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
    }
    .wrap { max-width: var(--container); margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: clamp(1.6rem, 2.6vw, 2.2rem); }
    .lede { margin: 0; color: #4b5563; max-width: 65ch; }

    .tri {
      display: grid;
      grid-template-columns: 1fr minmax(320px, 2fr) 1fr;
      gap: 16px;
      padding: 24px 16px 40px;
      align-items: start;
    }
    .tri > * { min-width: 0; }

    .panel {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .panel h2 { margin-top: 0; font-size: 1.05rem; }
    .panel p { margin: 0.4rem 0; color: #4b5563; }

    .map-shell {
      display: grid;
      gap: 12px;
      align-content: start;
    }
    .map-frame {
      width: 100%;
      height: clamp(420px, 68vh, 820px);
      border: 0;
      border-radius: 10px;
      overflow: hidden;
      display: block;
    }

    .ui, .source {
      font-size: 0.9rem;
      color: #555;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0 12px;
      flex-wrap: wrap;
    }
    #legend { margin-top: 8px; }
    #hoverInfo { margin-top: 8px; color: #374151; }

    @media (max-width: 960px) {
      .tri { grid-template-columns: 1fr; }
      .map-frame { height: clamp(360px, 60vh, 720px); }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Australian Energy — Choropleth Overview</h1>
      <p class="lede">
        Explore state and territory energy generation by source. Use the metric selector to switch between fuels,
        renewables, and totals. Hover a region to see details, or click to pin a popup.
      </p>
    </div>
  </header>

  <main class="wrap">
    <section class="tri">
      <!-- Left text panel + HOSTED CONTROLS -->
      <aside class="panel" aria-label="Left context">
        <h2>About the data</h2>
        <p>
          Figures represent annual generation (GWh) by fuel type. “Per cent renewable” shows the percentage share
          of renewables in total generation for each state/territory.
        </p>
        <p>
          Use the dropdown to compare wind, hydro, solar PV, and non-renewable sources. Values with no data are
          shown with a neutral fill.
        </p>

        <!-- Host-side UI mirrored from the iframe -->
        <div class="ui" aria-live="polite">
          <div class="controls" role="group" aria-label="Map controls">
            <label for="hostMetricSelect">Metric:</label>
            <select id="hostMetricSelect" aria-label="Select metric">
              <!-- options injected from iframe -->
            </select>
          </div>
          <div id="hoverInfo" class="info">Hover a state/territory</div>
          <div id="legend" class="legend" aria-label="Legend"></div>
        </div>
      </aside>

      <!-- Middle: Map, sandboxed in an iframe -->
      <div class="panel map-shell" aria-label="Map panel">
        <iframe
          id="mapFrame"
          class="map-frame"
          src="map/index.html"
          title="Choropleth map of Australia showing energy metrics by state"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
        ></iframe>
        <div class="source">Basemap © OpenStreetMap | Boundaries © contributors</div>
      </div>

      <!-- Right text panel -->
      <aside class="panel" aria-label="Right context">
        <h2>How to read the map</h2>
        <p>
          Darker shades indicate higher values for the selected metric. The gradient legend shows the scale
          (min–max) used to color the states.
        </p>
        <p>
          Switch metrics to see how patterns shift across the country. For consistent comparisons, you can also
          lock the legend scale (I can add a toggle).
        </p>
      </aside>
    </section>
  </main>

  <!-- Host <-> Iframe messaging glue -->
  <script>
    (function () {
      const frame = document.getElementById("mapFrame");
      const metricSelect = document.getElementById("hostMetricSelect");
      const legendHost = document.getElementById("legend");
      const hoverHost = document.getElementById("hoverInfo");

      function sendToMap(type, payload = {}) {
        try { frame.contentWindow.postMessage({ to: "aust-energy-map", type, ...payload }, "*"); }
        catch (e) {}
      }

      // Populate the host select from iframe-provided options
      function renderMetricOptions(options, value) {
        const prev = metricSelect.value;
        metricSelect.innerHTML = "";
        for (const opt of options) {
          const el = document.createElement("option");
          el.value = opt.value;
          el.textContent = opt.label;
          if (opt.selected || opt.value === value) el.selected = true;
          metricSelect.appendChild(el);
        }
        // If the selected value changed (initial load), push it back to the map so both sides match
        const chosen = metricSelect.value;
        if (chosen && chosen !== prev) {
          sendToMap("metric:set", { value: chosen });
        }
      }

      // Host select -> tell map to change metric
      metricSelect.addEventListener("change", () => {
        const value = metricSelect.value;
        sendToMap("metric:set", { value });
      });

      // Listen for updates coming from the map iframe
      window.addEventListener("message", (e) => {
        const msg = e.data || {};
        if (msg && msg.from === "aust-energy-map") {
          if (msg.type === "ready") {
            // Ask the map to sync its current UI state back to us
            sendToMap("sync:request");
          }
          if (msg.type === "metric:init") {
            renderMetricOptions(msg.options || [], msg.value);
          }
          if (msg.type === "metric:change") {
            // Map-side changed the metric (e.g., default selection) -> mirror into host select
            if (typeof msg.value === "string" && metricSelect.value !== msg.value) {
              metricSelect.value = msg.value;
            }
          }
          if (msg.type === "legend:update") {
            legendHost.innerHTML = msg.html || "";
          }
          if (msg.type === "hover:update") {
            hoverHost.innerHTML = msg.html || "";
          }
        }
      });
    })();
  </script>
</body>
</html>
